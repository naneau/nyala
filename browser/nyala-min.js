(function(){var a,b,c,d,e=Array.prototype.slice,f=function(a,b){return function(){return a.apply(b,arguments)}},g=Object.prototype.hasOwnProperty,h=function(a,b){function d(){this.constructor=a}for(var c in b)g.call(b,c)&&(a[c]=b[c]);d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype;return a};d=function(a,b){return(typeof module!="undefined"&&module!==null?module.exports:void 0)!=null?module.exports[a]=b:window[a]=b},a=function(){function a(){var a;a=1<=arguments.length?e.call(arguments,0):[];if(a.length===0)throw new Error("No function passed to Promise");this.scope=a.length>=2?a[1]:this,this.func=a[0],this.brokenHandlers=[],this.keptHandlers=[],this.inChains=[],void 0}a.prototype.kept=function(a){this.keptHandlers.push(a);return this},a.prototype.broken=function(a){this.brokenHandlers.push(a);return this},a.prototype.execute=function(){var a;a=1<=arguments.length?e.call(arguments,0):[];if(this.assert!=null&&!this.assert.apply(this,a))return this["break"]("Assertion failed");a.push(f(function(){a=1<=arguments.length?e.call(arguments,0):[];return this.keep.apply(this,a)},this)),a.push(f(function(){a=1<=arguments.length?e.call(arguments,0):[];return this["break"].apply(this,a)},this));return this.func.apply(this.scope,a)},a.prototype["break"]=function(){var a,b,c,d,f,g;a=1<=arguments.length?e.call(arguments,0):[],f=this.brokenHandlers,g=[];for(c=0,d=f.length;c<d;c++)b=f[c],g.push(b.apply(null,a));return g},a.prototype.keep=function(){var a,b,c,d,f,g;a=1<=arguments.length?e.call(arguments,0):[],this.filter&&(a=this.filter.apply(this,a)),Array.isArray(a)||(a=[a]),f=this.keptHandlers,g=[];for(c=0,d=f.length;c<d;c++)b=f[c],g.push(b.apply(null,a));return g},a.prototype.putInChain=function(a){return this.inChains.push(a)},a.prototype.isInChain=function(a){var b;return function(){var c,d,e,f;e=this.inChains,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b===a&&f.push(b);return f}.call(this).length>0};return a}(),d("Promise",a),b=function(){function a(){}return a}(),d("PromiseBurst",b),c=function(){function b(){var a,c,d,g;a=1<=arguments.length?e.call(arguments,0):[],b.__super__.constructor.call(this,f(function(){a=1<=arguments.length?e.call(arguments,0):[];return this.runStack.apply(this,a)},this)),this.promises=[];for(d=0,g=a.length;d<g;d++)c=a[d],this.add(c);this}h(b,a),b.prototype.add=function(){var b,c;b=1<=arguments.length?e.call(arguments,0):[],typeof b[0]=="function"?c=function(a,b,c){c.prototype=a.prototype;var d=new c,e=a.apply(d,b);return typeof e=="object"?e:d}(a,b,function(){}):c=b[0],this.promises.push(c);return this},b.prototype.runStack=function(){var a,b,c,d,g,h;a=3<=arguments.length?e.call(arguments,0,h=arguments.length-2):(h=0,[]),c=arguments[h++],b=arguments[h++],g=this.promises;if(g.length!==0){d=f(function(){var b,c,h;c=arguments[0],a=2<=arguments.length?e.call(arguments,1):[];if(g[c]==null)return this.keep.apply(this,a);h=g[c],h.isInChain(this)||(h.putInChain(this),b=!1,h.broken(f(function(){var a;a=1<=arguments.length?e.call(arguments,0):[],b=!0;return this["break"].apply(this,a)},this)),h.kept(function(){var a;a=1<=arguments.length?e.call(arguments,0):[];if(!b)return d.apply(null,[c+1].concat(e.call(a)))}));if(this.assertEach!=null&&!this.assertEach.apply(this,a))return this["break"]("Assertion failed on step "+(c+1));return h.execute.apply(h,a)},this);return d.apply(null,[0].concat(e.call(a)))}};return b}(),d("PromiseChain",c)}).call(this)